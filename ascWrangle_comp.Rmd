Comprehensive RUM of recreational activities ta Ningaloo

# Set up
```{r setup}
    rm(list = ls())

    # knitr options
    knitr::opts_chunk$set(warning = FALSE, message = TRUE, echo = FALSE, fig.align =
                            'center', fig.width = 10, fig.height = 7) 
    
    # libraries 
    library(tidyverse)
    library(dplyr)
    library(ggplot2)
    library(sp)
    library(raster)
    library(rgeos)
    library(rgdal)
    library(sf)
    library(lwgeom)
    library(googledrive)
    library(units)
    library(nngeo)
    library(magrittr)
    library(todor)
    library(mgcv)

    # data
    # BR <- st_read("./data/shp/natBR.shp") # boat ramps
    BRtrips <- readRDS("./data/gpkg/2.1_BRtrips.gpkg") %>% # from BRtrips.R
      st_transform(crs = 4283)
    
    npz <- st_read("./data/gpkg/ntz.gpkg") %>% 
      st_transform(crs = 4283)
    
    grid_base <- st_read("./data/gpkg/ascBase_v2.gpkg") %>% 
      st_transform(crs = 4283)
    
  sh_base <- st_read("./data/gpkg/shline_ascBase.gpkg") %>% 
      st_transform(crs = 4283)
    
    dat <- read_csv("data/01_data/1.2_dat.csv")
    
    bathy <- raster("./data/raster/NWSbathy.tif") # bathy
    
    # mp <- st_read("./data/gpkg/pmmp_4326.gpkg") %>% 
    #   st_transform(crs = 4283)
    
    coast <- st_read("./data/gpkg/coast.gpkg") %>% 
      st_transform(crs = 4283) %>% 
      dplyr::select(geom) 
    
    hol <- read_csv("./data/RAW/Holidays.csv") %>% 
      mutate(Date = as.Date(Date, format = "%d/%m/%y"))

    # consump <- read.csv("./data/RAW/consump.csv")
    
    boat_perf <- read.csv("./data/RAW/boatengines.csv")
    
    vott <- read.csv("./data/RAW/VOTT.csv")
    
    habitat <- st_read("./data/gpkg/ning_hab.gpkg") %>% 
      st_transform(crs = 4283) %>% 
      st_make_valid() %>% 
      mutate(habitat = tolower(habitat))
    
    gulf <- st_read("./data/gpkg/exgulf.gpkg") %>% 
      st_transform(crs = 4283)
    
    # get fuel csv from here
    # https://www.fuelwatch.wa.gov.au/retail/monthly
    # need to resave as proper csv format
    # jan - apr 2023
    fuel <- read_csv("./data/RAW/Monthly-ULP-prices-Gascoyne-201507-202109.csv")
    
    # models
    cons_mod <- readRDS("./models/cons_mod.rda")
    sp_mod <- readRDS("./models/sp_mod.rda")
    bl_mod <- readRDS("./models/bl_mod.rda")
    
    # simulation
    sim_name <- "sim1"       #'[#NOTE: check simulation name]  
    
    sim <- st_read(paste0("./data/gpkg/sims/asc_", sim_name, ".gpkg")) %>% 
      st_transform(crs = 4283)
    
    # functions
    source("./functions/spatialFunc.R") # spatial functions
    source("./functions/ascFunc.R") # function to make asc grid
    source("./functions/theme.R") # plot theme
    source("./functions/genFunc.R") # function for smple weighting
    
    sf_use_s2(FALSE)
```

# Define Activities

```{r}
dat %<>% 
  group_by(TripID) %>%      
  slice_max(decDuration, n = 1,  with_ties = F) # only picking observation with longest duration for each person 

dat %<>% 
  mutate(ActivityType = ifelse(Activity %in% "Fishing", "Extractive", "Non-Extractive")) %>% # both to ex or nex
  filter(!(Activity %in% c("JetSki", "Other"))) %>% 
  mutate(Activity = ifelse(Activity %in% "Beachgoing" & SiteType %in% "Boat", "Cruising", Activity)) %>%
  mutate(Activity = ifelse(Activity %in% c("Walking", "Explore"), "Beachgoing", Activity))

# define activities
table(dat$Activity, dat$SiteType)

dat %<>% 
  filter(!(Activity %in% "Megafauna" & SiteType %in% "Shore")) %>% # only one activity for each
  filter(!(Activity %in% "WindSport" & SiteType %in% "Boat")) %>% 
  filter(!(FishingType %in% "Demersal" & SiteType %in% "Shore")) %>% 
  filter(!(FishingType %in% "Trolling" & SiteType %in% "Shore")) %>% 
  mutate(FishingType = ifelse(FishingType %in% "Casting" & SiteType %in% "Boat", "Demersal", FishingType)) %>% 
  filter(!is.na(UseLat), !is.na(UseLong))  # filtering empty coords
```
Final activities:

Shore: beach (224), fishing (63), rowsport (13), snorkeling (160), surfing (18), windsport (8)
Boat: cruising (19), diving (8), megafauna (11), snorkeling (38), surfing (13) 

# Joining external data
## Fuel
```{r}
fuel %<>%
  mutate(TripMonth = gsub("[^a-zA-Z]", "", Month)) %>%
  mutate(season = ifelse(TripMonth %in% c("Sep", "Oct"), "Spring", 
                           ifelse(TripMonth %in% c("Jul", "Aug"), "Winter",
                                  "Autumn"))) %>% 
  mutate(numYear = as.numeric(paste0("20", as.numeric(gsub("[^0-9]", "", Month))))) %>%
  mutate(cost = Average/100)

dat %<>% left_join(fuel[, c("TripMonth", "numYear", "cost")])
```

## Boat length
Predicting as a function of party size to fill NAs
```{r}
# dat %<>% rename(PartySize = Party)
# tmp <- dat %>% filter(is.na(BoatLength) & SiteType == "Boat") %>% dplyr::select(TripID, BoatLength, PartySize)
# # unique(tmp$Party)
# 
# # Filling Party size where it exists
# tmp %<>% mutate(PartySize = ifelse(PartySize %in% c("6f", "Two couples 2 kids", "3F, 2M, 1b"), 6, 
#                                     ifelse(PartySize %in% c("2f", "2 dudes", "2males", "Couple", "1M 1b"), 2, 
#                                            ifelse(PartySize %in% c("2f, 2kids", "4 friends", "2 couples", "4 mates", "1m1b", "Couple, 2g", "Couple,2g 1b"), 4,
#                                                   ifelse(PartySize %in% c("Man", "1M"), 1, 
#                                                          ifelse(PartySize %in% c("2b1g", "3M", "3m"), 3, NA))))))
# 
#       tmp$lm_bl <- predict(bl_mod, tmp) # predicting boatlength using party size
#       tmp$lm_bl <- round(as.numeric(tmp$lm_bl), 2)
#       dat %<>%  left_join(tmp[, c("TripID", "lm_bl")])
#       
#       dat %<>% 
#         mutate(BoatLength = ifelse(SiteType == "Boat" & !is.na(lm_bl), lm_bl, BoatLength)) %>% # appending modelled boat length
#         mutate(BoatLength = ifelse(SiteType == "Boat" & is.na(BoatLength), mean(BoatLength, na.rm = T), BoatLength)) # filling rest of boat length with NAs
```

## VOTT
```{r}
# VOTT 
    dat %<>% left_join(vott[, c("Postcode", "ann_inc_21", "VOTT_21")]) 

    tmp <- dat %>% filter(!is.na(ann_inc_21) & !is.na(BoatLength)) %>% mutate(ann_inc_21 = as.numeric(ann_inc_21))

    lm_ann_inc <- lm(ann_inc_21 ~ BoatLength, data = tmp)
    

      # ggplot(dat = tmp, aes(x = ann_inc_21, y = BoatLength)) +
      #   geom_point() +
      #   stat_smooth(method = "lm")
      
      dat$lm_ann_inc <- predict(lm_ann_inc, dat)
      
      # mean(vott$ann_inc_21, na.rm = T) - mean(vott$ann_inc_16, na.rm = T)
      
      dat %<>%
        mutate(ann_inc = ifelse(!is.na(ann_inc_21), ann_inc_21, lm_ann_inc)) %>% 
        mutate(ann_inc = ifelse(is.na(ann_inc), mean(ann_inc, na.rm = T), ann_inc)) %>% 
        mutate(VOTT = round((ann_inc/(38*52))/3, 2))
```

## Boat specs
```{r}
# Consumption
boat_perf %<>%  
  filter(kmperh < 4000) %>% 
    mutate(boat_size2L = ifelse(boatlength <= 3.75, "S", "L")) %>%
  mutate(boat_size3L = ifelse(boatlength <= 3.75, "S", 
                            ifelse(boatlength <= 6.75, "M", "L"))) %>% 
  mutate(cons = kmperl/nEngines)

boat3L <- boat_perf %>% 
  group_by(boat_size3L) %>% 
  summarise(sp3l = median(kmperh),
            cons3l = median(cons))

boat2L <- boat_perf %>% 
  group_by(boat_size2L) %>% 
  summarise(sp2l = median(kmperh),
            cons2l = median(cons))
  
dat %<>% 
  mutate(BoatLength = ifelse(is.na(BoatLength), mean(BoatLength, na.rm = TRUE), BoatLength)) %>%
  mutate(boat_size2L = ifelse(BoatLength <= 3.75, "S", "L")) %>%
  mutate(boat_size3L = ifelse(BoatLength <= 3.75, "S", 
                            ifelse(BoatLength <= 6.75, "M", "L")))  %>% 
  left_join(boat2L[, c("boat_size2L", "cons2l", "sp2l")], by = "boat_size2L") %>% 
  left_join(boat3L[, c("boat_size3L", "cons3l", "sp3l")], by = "boat_size3L")

dat %<>% 
  mutate(cons_flt = median(boat_perf$cons)) %>% 
  mutate(sp_flt = median(boat_perf$kmperh))

# modeled consumption
 temp <- dat %>% 
        dplyr::select(BoatLength) %>% 
        rename(boatlength = BoatLength) %>% 
        st_drop_geometry()
      
      gam_cons <- predict(cons_mod, temp)
      gam_sp <- predict(sp_mod, temp)
      
      dat$gam_cons <- as.numeric(gam_cons)
      dat$gam_sp <- as.numeric(gam_sp)


rm(fuel, boat2L, boat3L, vott, temp, gam_cons, sp_cons, cons_mod, sp_mod, tmp, bl_mod)
```

# Filtering
All data filters have to be done before making the choice set.
```{r}
    dat %<>% 
      # filter(!is.na(UseLat), !is.na(UseLong)) %>% # filtering empty coords
      st_as_sf(coords = c("UseLong", "UseLat"), crs = 4283)  ## make sf object
    
      #'[#VALIDATE: TRUE, no duplicated trip IDs)]
      identical((which(duplicated(dat$TripID) == TRUE)), integer(0)) == TRUE
```

# Weighting
```{r}
    # prep for getting survey weights
    # will duplicate rows which are in public and school holiday - changing to school for weighting and removing duplicates
    dat %<>% left_join(hol, by = c("SurveyDate" = "Date"))

    tmp <- dat[which(duplicated(dat$TripID)), ] %>% dplyr::select(TripID) 

   dat <- dat %>%
     mutate(Holiday = ifelse(TripID %in% tmp$TripID, "school", Holiday)) %>%
     distinct()

    dat <- dat %>%
      mutate(DayType = weekdays(Date_posix, abbreviate = TRUE)) %>% 
      mutate(DayType = ifelse(DayType %in% c("Sat", "Sun"), "Weekend", "Weekday")) %>%
      mutate(DayType = ifelse(Holiday %in% "public", "Weekend", DayType)) %>%
      mutate(Holiday = as.factor(ifelse(Holiday %in% "school", "1", "0"))) %>%
      unite("psuid", c(SurveyDate, Time, Site), remove = F, sep = " ")

    # calculating nipw weights
    ## site
    w_site <- even_nipw(df = dat, psuid = psuid, w_col = "Site") 
    dat %<>% left_join(w_site[, c("Site", "Site_nipw")])
    
    # time
    w_time <- even_nipw(df = dat, psuid = psuid, w_col = "Time") 
    dat %<>% left_join(w_time[, c("Time", "Time_nipw")])
      
    ## holiday - not balanced
    # Holidays
    nhol <- hol %>% filter(Holiday == "school")  %>% nrow() # dates of school holidays in sample year
    
    w_hol <- as.data.frame(table(dat$Holiday)) %>% 
      mutate(target = ifelse(Var1 %in% 0, ((365*4) - nhol)/(365*4), nhol/(365*4))) %>% 
      mutate(real = Freq/(sum(Freq))) %>% 
      mutate(ipw = target/real) %>% 
      mutate(hol_nipw = ipw/(sum(ipw))) %>% 
      rename(Holiday = Var1)
    
    sum(w_hol$hol_nipw)  # checkpoint: == 1 
    dat %<>% left_join(w_hol[, c("Holiday", "hol_nipw")]) # append

    # DayType
    wdat <- dat %>% distinct(psuid, .keep_all = TRUE) # filtering to primary sampling units
    
    w_daytype <- as.data.frame(table(wdat$DayType)) %>%
      mutate(target = ifelse(Var1 %in% "Weekend", (4*(2*52))/360, (4*(5*52))/360)) %>%
      mutate(real = Freq/sum(Freq)) %>% 
      mutate(ipw = target/real) %>% 
      mutate(dt_nipw = ipw/sum(ipw)) %>% 
      rename(DayType = Var1)
    
    sum(w_daytype$dt_nipw) # checkpoint: == 1
    dat %<>% left_join(w_daytype[, c("DayType", "dt_nipw")])  # append

    # overall weight
    dat %<>% mutate(ipw = Site_nipw + hol_nipw + dt_nipw + Time_nipw) # w_time removed so same as south cpoast
    
    # dat %<>% mutate(nipw = ipw/sum(ipw))
    # 
    # sum(dat$nipw)
```

# Beach grid
```{r}
 dat <- st_crop(dat, grid_base) # removing outliers 

# asc grid
    grid <- ASCgrid(poly = sh_base, sz_current = npz, sz_sim = sim, point = dat, from = 0.03,
                    by = 0.02, crs = 4283, vert = FALSE) 

#'[#NOTE:Check empty grids before removing]  
  emp <- grid[which(grid$data_present == FALSE),]
  grid %<>% filter(gridID_alt != emp$gridID_alt) 
  
  ggplot() +
  geom_sf(data = grid, aes(fill = area))
```

